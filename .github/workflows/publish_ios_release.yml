name: ios-build-action

# 推送Tag时触发
on:
  push:
    tags:
      - "ios_*"

jobs:
  build-ios:
    # 使用一个具体的 macOS 版本以保证环境稳定
    runs-on: macos-13

    permissions:
      contents: write

    steps:
      # 步骤 1: 签出代码
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      # 步骤 2: 明确指定 Xcode 版本
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # 步骤 3: 设置 Java 环境
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"

      # 步骤 4: 设置 Flutter 环境
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true

      # 步骤 5: 清理项目并获取 Flutter 依赖
      - name: Clean project and get Flutter packages
        run: |
          cd simple_live_app
          flutter clean
          flutter pub get

      # 步骤 6: 修改现有的 post_install 钩子并安装 iOS Pods 依赖
      - name: Prepare and install iOS dependencies
        run: |
          cd simple_live_app/ios
          # 检查并修改现有的 post_install 钩子，确保设置了正确的部署目标
          sed -i '' '/post_install do |installer|/,/end/c\
          post_install do |installer|\
            installer.pods_project.targets.each do |target|\
              target.build_configurations.each do |config|\
                config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "12.0"\
              end\
            end\
          end\
          ' Podfile
          # 现在 Generated.xcconfig 文件已存在，可以安全地运行 pod install
          pod install --repo-update

      # 步骤 7: 打包 iOS 应用 (IPA)
      - name: Build IPA
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign

      # 步骤 8: 创建未签名的 IPA 文件
      - name: Create unsigned IPA
        run: |
          cd simple_live_app
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -r ios_no_sign.ipa Payload

      # 步骤 9: 上传 IPA 至 Artifacts
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # 步骤 10: 读取版本信息
      - name: Read version information
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          path: assets/app_version.json

      - name: Echo version details
        run: |
          echo "Version: ${{ fromJson(steps.version.outputs.content).version }}"
          echo "Version Description: ${{ fromJson(steps.version.outputs.content).version_desc }}"

      # 步骤 11: (可选) 上传至 Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "iOS ${{ fromJson(steps.version.outputs.content).version }}"
          body: "# iOS版本\n${{ fromJson(steps.version.outputs.content).version_desc }}"
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          token: ${{ secrets.TOKEN }}
          files: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # 步骤 12: 完成提示
      - name: Finalizing build
        run: echo "🍎 iOS build completed with status ${{ job.status }}."