# å·¥ä½œæµç¨‹åç§°
name: Build and Release iOS App

# è§¦å‘æ¡ä»¶ï¼šå½“ä¸€ä¸ªä»¥ 'ios_' å¼€å¤´çš„æ ‡ç­¾è¢«æ¨é€åˆ°ä»“åº“æ—¶
on:
  push:
    tags:
      - "ios_*"

# å®šä¹‰ä¸€ä¸ªæ„å»ºä»»åŠ¡
jobs:
  build-and-release-ios:
    # ä»»åŠ¡åç§°
    name: Build and Release iOS
    # ä½¿ç”¨ macOS 13 è¿è¡Œç¯å¢ƒ
    runs-on: macos-13

    # ä¸ºæ­¤ä»»åŠ¡æˆäºˆå†™æƒé™ï¼Œä»¥ä¾¿èƒ½å¤Ÿåˆ›å»º GitHub Release
    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: ç­¾å‡ºä½ çš„ä»“åº“ä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      # æ­¥éª¤ 2: æ˜ç¡®æŒ‡å®š Xcode ç‰ˆæœ¬ä»¥ä¿è¯æ„å»ºç¯å¢ƒçš„ç¨³å®šæ€§
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # æ­¥éª¤ 3: è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true

      # æ­¥éª¤ 4: æ¸…ç†é¡¹ç›®å¹¶è·å– Flutter ä¾èµ–
      - name: Clean project and get Flutter packages
        run: |
          cd simple_live_app
          flutter clean
          flutter pub get

      # æ­¥éª¤ 5: ä¿®å¤ Podfile å¹¶å®‰è£… iOS ä¾èµ– (å…³é”®ä¿®å¤)
      - name: Patch Podfile and install iOS dependencies
        run: |
          cd simple_live_app/ios
          
          # Podfile å·²å­˜åœ¨ post_install å—ï¼Œæˆ‘ä»¬ä¸èƒ½æ·»åŠ ç¬¬äºŒä¸ªã€‚
          # æ­¤è„šæœ¬å°†æˆ‘ä»¬çš„éƒ¨ç½²ç›®æ ‡ä¿®å¤ä»£ç æ³¨å…¥åˆ°ç°æœ‰çš„ post_install å—å†…éƒ¨ï¼Œ
          # æ°å¥½åœ¨æ–‡ä»¶æœ«å°¾çš„ 'end' å…³é”®å­—ä¹‹å‰ã€‚

          # 1. å¤åˆ¶é™¤æœ€åä¸€è¡Œå¤–çš„æ‰€æœ‰å†…å®¹åˆ°ä¸´æ—¶æ–‡ä»¶
          head -n -1 Podfile > Podfile.tmp
          
          # 2. å°†æˆ‘ä»¬çš„ä¿®å¤è„šæœ¬è¿½åŠ åˆ°ä¸´æ—¶æ–‡ä»¶
          echo "
            # Injected by CI: Force all pods to iOS 12.0 deployment target
            installer.pods_project.targets.each do |target|
              target.build_configurations.each do |config|
                config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '12.0'
              end
            end
          " >> Podfile.tmp
          
          # 3. å°†åŸå§‹æ–‡ä»¶çš„æœ€åä¸€è¡Œï¼ˆ'end'ï¼‰è¿½åŠ å›æ¥
          tail -n 1 Podfile >> Podfile.tmp
          
          # 4. ç”¨ä¿®æ”¹åçš„ä¸´æ—¶æ–‡ä»¶æ›¿æ¢åŸå§‹ Podfile
          mv Podfile.tmp Podfile
          
          echo "--- Patched Podfile Content ---"
          cat Podfile
          echo "-----------------------------"
          
          # 5. ç°åœ¨ï¼Œä½¿ç”¨ä¿®å¤åçš„ Podfile å®‰è£…ä¾èµ–
          pod install --repo-update

      # æ­¥éª¤ 6: æ„å»º iOS åº”ç”¨ (ç”Ÿæˆ .app æ–‡ä»¶)
      - name: Build iOS App
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign

      # æ­¥éª¤ 7: å°† .app æ–‡ä»¶æ‰“åŒ…æˆæœªç­¾åçš„ .ipa
      - name: Create unsigned IPA
        run: |
          cd simple_live_app
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -r ios_no_sign.ipa Payload

      # æ­¥éª¤ 8: è¯»å–ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      - name: Read version information
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          path: assets/app_version.json

      # æ­¥éª¤ 9: åˆ›å»º GitHub Release å¹¶ä¸Šä¼  IPA æ–‡ä»¶
      - name: Create GitHub Release and Upload IPA
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "iOS ${{ fromJson(steps.version.outputs.content).version }}"
          body: |
            # iOS ç‰ˆæœ¬æ›´æ–°
            ${{ fromJson(steps.version.outputs.content).version_desc }}
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # æ­¥éª¤ 10: è¾“å‡ºæœ€ç»ˆçŠ¶æ€
      - name: Finalizing build
        run: echo "ğŸ iOS build and release process completed with status ${{ job.status }}."