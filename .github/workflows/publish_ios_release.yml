name: ios-build-action

# æ¨é€Tagæ—¶è§¦å‘
on:
  push:
    tags:
      - "ios_*"

jobs:
  build-ios:
    # ä½¿ç”¨ä¸€ä¸ªå…·ä½“çš„ macOS ç‰ˆæœ¬ä»¥ä¿è¯ç¯å¢ƒç¨³å®š
    runs-on: macos-13

    permissions:
      contents: write

    steps:
      # æ­¥éª¤ 1: ç­¾å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      # æ­¥éª¤ 2: æ˜ç¡®æŒ‡å®š Xcode ç‰ˆæœ¬
      - name: Select Xcode version
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'

      # æ­¥éª¤ 3: è®¾ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: "17"

      # æ­¥éª¤ 4: è®¾ç½® Flutter ç¯å¢ƒ
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.x'
          cache: true

      # æ­¥éª¤ 5: æ¸…ç†é¡¹ç›®å¹¶è·å– Flutter ä¾èµ–
      - name: Clean project and get Flutter packages
        run: |
          cd simple_live_app
          flutter clean
          flutter pub get

      # æ­¥éª¤ 6: ä¿®æ”¹ç°æœ‰çš„ post_install é’©å­å¹¶å®‰è£… iOS Pods ä¾èµ–
      - name: Prepare and install iOS dependencies
        run: |
          cd simple_live_app/ios
          # æ£€æŸ¥å¹¶ä¿®æ”¹ç°æœ‰çš„ post_install é’©å­ï¼Œç¡®ä¿è®¾ç½®äº†æ­£ç¡®çš„éƒ¨ç½²ç›®æ ‡
          sed -i '' '/post_install do |installer|/,/end/c\
          post_install do |installer|\
            installer.pods_project.targets.each do |target|\
              target.build_configurations.each do |config|\
                config.build_settings["IPHONEOS_DEPLOYMENT_TARGET"] = "12.0"\
              end\
            end\
          end\
          ' Podfile
          # ç°åœ¨ Generated.xcconfig æ–‡ä»¶å·²å­˜åœ¨ï¼Œå¯ä»¥å®‰å…¨åœ°è¿è¡Œ pod install
          pod install --repo-update

      # æ­¥éª¤ 7: æ‰“åŒ… iOS åº”ç”¨ (IPA)
      - name: Build IPA
        run: |
          cd simple_live_app
          flutter build ios --release --no-codesign

      # æ­¥éª¤ 8: åˆ›å»ºæœªç­¾åçš„ IPA æ–‡ä»¶
      - name: Create unsigned IPA
        run: |
          cd simple_live_app
          mkdir -p build/ios/iphoneos/Payload
          cp -R build/ios/iphoneos/Runner.app build/ios/iphoneos/Payload/Runner.app
          cd build/ios/iphoneos/
          zip -r ios_no_sign.ipa Payload

      # æ­¥éª¤ 9: ä¸Šä¼  IPA è‡³ Artifacts
      - name: Upload IPA to Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-ipa
          path: simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # æ­¥éª¤ 10: è¯»å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Read version information
        id: version
        uses: juliangruber/read-file-action@v1
        with:
          path: assets/app_version.json

      - name: Echo version details
        run: |
          echo "Version: ${{ fromJson(steps.version.outputs.content).version }}"
          echo "Version Description: ${{ fromJson(steps.version.outputs.content).version_desc }}"

      # æ­¥éª¤ 11: (å¯é€‰) ä¸Šä¼ è‡³ Release
      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: "iOS ${{ fromJson(steps.version.outputs.content).version }}"
          body: "# iOSç‰ˆæœ¬\n${{ fromJson(steps.version.outputs.content).version_desc }}"
          prerelease: ${{ fromJson(steps.version.outputs.content).prerelease }}
          token: ${{ secrets.TOKEN }}
          files: |
            simple_live_app/build/ios/iphoneos/ios_no_sign.ipa

      # æ­¥éª¤ 12: å®Œæˆæç¤º
      - name: Finalizing build
        run: echo "ğŸ iOS build completed with status ${{ job.status }}."